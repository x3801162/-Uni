{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["import { showLoading, hideLoading, btnHideLoading } from \"./plugIn/globalLoading\";\r\nimport store from \"@/store/index\";\r\nimport { DOMAIN_PREFIX } from \"@/config/api\";\r\nimport { ERROR_CODES, ERROR_MESSAGES, ERROR_TYPES, ERROR_CODE_TO_TYPE, REQUEST_TIMEOUT } from \"@/utils/ERROR_DATA\";\r\n\r\n// 公共请求函数\r\nconst _request = (url, data, method, loading, responseType, header, resolveWithData = true) => {\r\n    if (loading) {\r\n        showLoading();\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n        uni.request({\r\n            url: url,\r\n            data: data,\r\n            method: method,\r\n            header: header,\r\n            responseType: responseType || '',\r\n            timeout: REQUEST_TIMEOUT,\r\n            success: res => {\r\n                hideLoading();\r\n                btnHideLoading();\r\n                if (res.data.code == 200) {\r\n                    resolve(resolveWithData ? res.data.data : res.data);\r\n                } else {\r\n                    let error;\r\n                    let errorCode = res.data.code || res.statusCode;\r\n                    let errorType, errorMessage;\r\n\r\n                    // 根据错误码确定错误类型和消息\r\n                    errorType = ERROR_CODE_TO_TYPE[errorCode] || ERROR_TYPES.BAD_REQUEST;\r\n\r\n                    // 优先使用服务器返回的消息，否则使用默认消息\r\n                    errorMessage = res.data.message || ERROR_MESSAGES[errorType];\r\n                    // 构建错误对象\r\n                    error = {\r\n                        type: errorType,\r\n                        code: errorCode,\r\n                        message: errorMessage,\r\n                        original: res\r\n                    };\r\n\r\n                    // 显示错误提示\r\n                    uni.showToast({\r\n                        title: error.code + ERROR_MESSAGES[errorType],\r\n                        icon: \"none\",\r\n                    });\r\n\r\n                    reject(error);\r\n                }\r\n            },\r\n            fail: err => {\r\n                hideLoading();\r\n                btnHideLoading();\r\n                let error;\r\n                let errorType, errorMessage;\r\n\r\n                // 处理网络错误和超时错误\r\n                if (err.errMsg.includes('timeout')) {\r\n                    errorType = ERROR_TYPES.TIMEOUT_ERROR;\r\n                } else {\r\n                    errorType = ERROR_TYPES.NETWORK_ERROR;\r\n                }\r\n                errorMessage = ERROR_MESSAGES[errorType];\r\n\r\n                // 构建错误对象\r\n                error = {\r\n                    type: errorType,\r\n                    code: ERROR_CODES[errorType],\r\n                    message: errorMessage,\r\n                    original: err\r\n                };\r\n\r\n                // 显示错误提示\r\n                uni.showToast({\r\n                    title: error.code + ERROR_MESSAGES[errorType],\r\n                    icon: \"none\",\r\n                });\r\n\r\n                reject(error);\r\n            }\r\n        });\r\n    });\r\n};\r\n\r\nconst request = (url, data, method = \"GET\", loading = true, responseType) => {\r\n    // 第一次进入\r\n    if (!uni.getStorageSync(\"access_token\")) {\r\n        return new Promise((resolve, reject) => {\r\n            getToken(DOMAIN_PREFIX).then(res => {\r\n                if (res.code == 200) {\r\n                    let header = {\r\n                        \"Content-Type\": \"application/json\",\r\n                        \"Zk-Env\": 'open'\r\n                    };\r\n                    const access_token = uni.getStorageSync(\"access_token\");\r\n                    if (access_token) {\r\n                        header[\"Authorization\"] = `bearer ${access_token}`;\r\n                    }\r\n                    _request(url, data, method, loading, responseType, header)\r\n                        .then(resolve)\r\n                        .catch(reject);\r\n                }\r\n            })\r\n        });\r\n    } else {\r\n        // 非第一次进入，直接请求\r\n        let header = {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Zk-Env\": 'open'\r\n        };\r\n        const access_token = uni.getStorageSync(\"access_token\");\r\n        if (access_token) {\r\n            header[\"Authorization\"] = `bearer ${access_token}`;\r\n        }\r\n        return _request(url, data, method, loading, responseType, header);\r\n    }\r\n};\r\n\r\nconst getToken = (url) => {\r\n    return new Promise((resolve, reject) => {\r\n        uni.login({\r\n            success: (loginRes) => {\r\n                const gzh = uni.getStorageSync('gzh')\r\n                const user_mark = uni.getStorageSync('user_mark');\r\n                var datas = {\r\n                    code: loginRes.code,\r\n                    wx_applet_id: store.state.globalSetting.appSetting.wx_applet_id,\r\n                }\r\n\r\n                if (gzh != '') {\r\n                    datas.wx_account_appid = gzh\r\n                }\r\n                if (user_mark != '') {\r\n                    datas.user_mark = user_mark - 0\r\n                }\r\n\r\n                uni.request({\r\n                    url: `${url}/vadmin/auth/wx/openid`,\r\n                    method: \"POST\",\r\n                    data: datas,\r\n                    success: (newAccessTokenRes) => {\r\n                        if (newAccessTokenRes.data.code === 200) {\r\n                            const access_token = newAccessTokenRes.data.data.access_token;\r\n                            if (access_token) {\r\n                                uni.setStorageSync(\"access_token\", access_token);\r\n                            }\r\n                            if (newAccessTokenRes.data.base_url) {\r\n                                uni.setStorageSync(\"base_url\", newAccessTokenRes.data.data.base_url);\r\n                            }\r\n                            if (newAccessTokenRes.data.tel) {\r\n                                uni.setStorageSync(\"tel\", newAccessTokenRes.data.data.tel);\r\n                            }\r\n                            resolve(newAccessTokenRes.data);\r\n                        } else {\r\n                            reject(newAccessTokenRes);\r\n                        }\r\n                    },\r\n                    fail: (err) => {\r\n                        reject(err);\r\n                    }\r\n                });\r\n            },\r\n            fail: (err) => {\r\n                reject(err);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n//不带token接口请求，首页\r\nconst request_noToken = (url, data, method = \"GET\", loading = true, responseType) => {\r\n    let header = {\r\n        \"Content-Type\": \"application/json\",\r\n        tenant: \"MDAwMA==\",\r\n    };\r\n    return _request(url, data, method, loading, responseType, header, false);\r\n};\r\n\r\nexport { request, request_noToken };\r\n"],"names":["showLoading","uni","REQUEST_TIMEOUT","hideLoading","btnHideLoading","ERROR_CODE_TO_TYPE","ERROR_TYPES","ERROR_MESSAGES","ERROR_CODES","DOMAIN_PREFIX","store"],"mappings":"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"}
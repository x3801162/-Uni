{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["import axios from \"axios\";\r\nimport { showLoading, hideLoading, btnHideLoading } from \"./plugIn/globalLoading\";\r\nimport store from \"@/store/index\";\r\nimport { DOMAIN_PREFIX } from \"@/config/api\";\r\n\r\nconst request = (url, data, method = \"GET\", loading = true, responseType) => {\r\n    // 第一次进入\r\n    if (!uni.getStorageSync(\"access_token\")) {\r\n\r\n        return new Promise((resolve, reject) => {\r\n            getToken(DOMAIN_PREFIX).then(res => {\r\n                if (res.code == 200) {\r\n                    let header = {\r\n                        \"Content-Type\": \"application/json\",\r\n                        \"Zk-Env\": 'open'\r\n                    };\r\n                    const access_token = uni.getStorageSync(\"access_token\");\r\n                    if (access_token) {\r\n                        header[\"Authorization\"] = `bearer ${access_token}`;\r\n                    }\r\n                    if (loading) {\r\n                        showLoading();\r\n                    }\r\n                    uni.request({\r\n                        url: url,\r\n                        data: data,\r\n                        method: method,\r\n                        header: header,\r\n                        responseType: responseType || '',\r\n                        success: res => {\r\n                            hideLoading();\r\n                            btnHideLoading();\r\n                            if (res.data.code == 200) {\r\n                                if (responseType) {\r\n                                    resolve(res.data);\r\n                                } else if (res.data.code === 200 || res.data.code === \"\") {\r\n                                    resolve(res.data.data);\r\n                                } else {\r\n                                    uni.showToast({\r\n                                        title: res.data.message,\r\n                                        icon: \"none\",\r\n                                    });\r\n                                    reject(res);\r\n                                }\r\n                            } else {\r\n                                reject(res);\r\n                            }\r\n                        },\r\n                        fail: res => {\r\n                            hideLoading();\r\n                            btnHideLoading();\r\n                            reject(res);\r\n                        },\r\n                    });\r\n\r\n                }\r\n            })\r\n        })\r\n    } else {\r\n        // 非第一次进入，直接请求\r\n        return new Promise((resolve, reject) => {\r\n            let header = {\r\n                \"Content-Type\": \"application/json\",\r\n                \"Zk-Env\": 'open'\r\n            };\r\n            const access_token = uni.getStorageSync(\"access_token\");\r\n            if (access_token) {\r\n                header[\"Authorization\"] = `bearer ${access_token}`;\r\n            }\r\n            if (loading) {\r\n                showLoading();\r\n            }\r\n            uni.request({\r\n                url: url,\r\n                data: data,\r\n                method: method,\r\n                header: header,\r\n                responseType: responseType || '',\r\n                success: res => {\r\n                    hideLoading();\r\n                    btnHideLoading();\r\n                    if (res.data.code == 200) {\r\n                        if (responseType) {\r\n                            resolve(res.data);\r\n                        } else if (res.data.code === 200 || res.data.code === \"\") {\r\n                            resolve(res.data.data);\r\n                        } else {\r\n                            uni.showToast({\r\n                                title: res.data.message,\r\n                                icon: \"none\",\r\n                            });\r\n                            reject(res);\r\n                        }\r\n                    } else {\r\n                        reject(res);\r\n                    }\r\n                },\r\n                fail: res => {\r\n                    hideLoading();\r\n                    btnHideLoading();\r\n                    reject(res);\r\n                },\r\n            });\r\n        })\r\n    }\r\n\r\n\r\n\r\n};\r\n//不带token接口请求，首页\r\nconst request_noToken = (url, data, method = \"GET\", loading = true, responseType) => {\r\n    if (loading) {\r\n        showLoading();\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n        let header = {\r\n            \"Content-Type\": \"application/json\",\r\n            tenant: \"MDAwMA==\",\r\n        };\r\n        showLoading();\r\n        uni.request({\r\n            url: url,\r\n            data: data,\r\n            method: method,\r\n            header: header,\r\n            success: res => {\r\n                hideLoading();\r\n                btnHideLoading();\r\n                if (res.data.code === 200 || data.code === \"\") {\r\n                    resolve(res.data);\r\n                    hideLoading();\r\n                } else {\r\n                    reject(res);\r\n                }\r\n            },\r\n            fail: res => {\r\n                hideLoading();\r\n                btnHideLoading();\r\n                reject(res);\r\n            },\r\n        });\r\n    });\r\n};\r\n\r\nconst getToken = (url) => {\r\n    return new Promise((resolve, reject) => {\r\n        uni.login({\r\n            success: (loginRes) => {\r\n                const gzh = uni.getStorageSync('gzh')\r\n                const user_mark = uni.getStorageSync('user_mark');\r\n                var datas = {\r\n                    code: loginRes.code,\r\n                    wx_applet_id: store.state.globalSetting.appSetting.wx_applet_id,\r\n                }\r\n\r\n                if (gzh != '') {\r\n                    datas.wx_account_appid = gzh\r\n                }\r\n                if (user_mark != '') {\r\n                    datas.user_mark = user_mark - 0\r\n                }\r\n\r\n                uni.request({\r\n                    url: `${url}/vadmin/auth/wx/openid`,\r\n                    method: \"POST\",\r\n                    data: datas,\r\n                    success: (newAccessTokenRes) => {\r\n                        if (newAccessTokenRes.data.code === 200) {\r\n                            const access_token = newAccessTokenRes.data.data.access_token;\r\n                            if (access_token) {\r\n                                uni.setStorageSync(\"access_token\", access_token);\r\n                            }\r\n                            if (newAccessTokenRes.data.base_url) {\r\n                                uni.setStorageSync(\"base_url\", newAccessTokenRes.data.data.base_url);\r\n                            }\r\n                            if (newAccessTokenRes.data.tel) {\r\n                                uni.setStorageSync(\"tel\", newAccessTokenRes.data.data.tel);\r\n                            }\r\n                            resolve(newAccessTokenRes.data);\r\n                        } else {\r\n                            reject(newAccessTokenRes);\r\n                        }\r\n                    },\r\n                    fail: (err) => {\r\n                        reject(err);\r\n                    }\r\n                });\r\n            },\r\n            fail: (err) => {\r\n                reject(err);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\nexport { request, request_noToken, getToken };\r\n"],"names":["uni","DOMAIN_PREFIX","showLoading","res","hideLoading","btnHideLoading","store"],"mappings":"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"}
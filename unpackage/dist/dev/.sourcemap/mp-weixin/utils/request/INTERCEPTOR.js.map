{"version":3,"file":"INTERCEPTOR.js","sources":["utils/request/INTERCEPTOR.js"],"sourcesContent":["import store from \"@/store/index\";\nimport md5Module from \"@/uni_modules/vk-uview-ui/libs/function/md5\";\nimport deepClone from \"@/uni_modules/vk-uview-ui/libs/function/deepClone\";\n\nconst md5 = md5Module.md5;\n\n// 请求拦截器配置\nexport const INTERCEPTOR_CONFIG = {\n  // 参数格式转换\n  enableFormatTransform: true,\n  // 通用参数补全\n  enableCommonParams: true,  \n  // 敏感参数处理\n  enableSensitiveParams: true,\n  // 防重复提交\n  enableDuplicateControl: true,\n  // 日志记录\n  enableLogging: false\n};\n \n// 敏感参数配置\nexport const SENSITIVE_PARAMS_CONFIG = {\n  // 需要加密的参数\n  encryptParams: ['password', 'oldPassword', 'newPassword', 'confirmPassword'],\n  // 需要脱敏的参数\n  desensitizeParams: ['phone', 'mobile', 'idCard', 'cardNo'],\n  // 加密密钥（实际项目中应从安全位置获取）\n  encryptKey: 'your-encryption-key',\n  // 脱敏规则：保留前几位和后几位\n  desensitizeRule: { phone: [3, 4], idCard: [6, 4], cardNo: [4, 4] }\n};\n\n// 防重复提交配置\nexport const DUPLICATE_CONFIG = {\n  // 锁定时间（毫秒）\n  lockTime: 3000,\n  // 请求ID生成规则\n  generateRequestId: (url, data, method) => {\n    return md5(url + JSON.stringify(data) + method);\n  }\n};\n\n// 已发送的请求锁\nconst requestLocks = new Map();\n\n// 通用参数生成器\nexport const generateCommonParams = () => {\n  // 需要啥传啥\n  return {\n    \n  };\n};\n\n// 参数格式转换：JSON转form-data\nexport const transformToFormData = (data) => {\n  const formData = new FormData();\n  for (const key in data) {\n    if (data.hasOwnProperty(key)) {\n      formData.append(key, data[key]);\n    }\n  }\n  return formData;\n};\n\n// 敏感参数处理\nexport const handleSensitiveParams = (data) => {\n  const processedData = deepClone(data);\n  \n  // 加密处理\n  SENSITIVE_PARAMS_CONFIG.encryptParams.forEach(param => {\n    if (processedData[param]) {\n      // 使用MD5加密（实际项目中应使用更安全的加密算法）\n      processedData[param] = md5(processedData[param] + SENSITIVE_PARAMS_CONFIG.encryptKey);\n    }\n  });\n  \n  // 脱敏处理\n  SENSITIVE_PARAMS_CONFIG.desensitizeParams.forEach(param => {\n    if (processedData[param]) {\n      const value = String(processedData[param]);\n      const rule = SENSITIVE_PARAMS_CONFIG.desensitizeRule[param];\n      if (rule && rule.length === 2) {\n        const [keepStart, keepEnd] = rule;\n        const maskLength = value.length - keepStart - keepEnd;\n        if (maskLength > 0) {\n          processedData[param] = value.slice(0, keepStart) + '*'.repeat(maskLength) + value.slice(-keepEnd);\n        }\n      }\n    }\n  });\n  \n  return processedData;\n};\n\n// 防重复提交检查\nexport const checkDuplicateRequest = (url, data, method) => {\n  const requestId = DUPLICATE_CONFIG.generateRequestId(url, data, method);\n  \n  if (requestLocks.has(requestId)) {\n    const lockTime = requestLocks.get(requestId);\n    if (Date.now() - lockTime < DUPLICATE_CONFIG.lockTime) {\n      return { isDuplicate: true, requestId };\n    }\n  }\n  \n  // 添加锁\n  requestLocks.set(requestId, Date.now());\n  \n  // 设置自动释放锁\n  setTimeout(() => {\n    requestLocks.delete(requestId);\n  }, DUPLICATE_CONFIG.lockTime);\n  \n  return { isDuplicate: false, requestId };\n};\n\n// 释放请求锁\nexport const releaseRequestLock = (requestId) => {\n  requestLocks.delete(requestId);\n};\n\n// 日志记录\nexport const logRequest = (url, data, method, header, stage) => {\n  if (!INTERCEPTOR_CONFIG.enableLogging) return;\n  \n  console.log(`[Request Logger] ${stage}:`);\n  console.log(`  URL: ${url}`);\n  console.log(`  Method: ${method}`);\n  console.log(`  Data:`, data);\n  console.log(`  Header:`, header);\n};\n\n// 请求拦截器中间件\nexport const requestInterceptor = (url, data, method, header) => {\n  let processedData = deepClone(data || {});\n  let processedHeader = { ...header };\n  let requestInfo = { url, data: processedData, method, header: processedHeader };\n  \n  // 1. 防重复提交检查\n  if (INTERCEPTOR_CONFIG.enableDuplicateControl) {\n    const { isDuplicate, requestId } = checkDuplicateRequest(url, processedData, method);\n    if (isDuplicate) {\n      uni.showToast({\n        title: '请勿重复提交',\n        icon: 'none'\n      });\n      throw new Error('Duplicate request');\n    }\n    requestInfo.requestId = requestId;\n  }\n  \n  // 2. 通用参数补全\n  if (INTERCEPTOR_CONFIG.enableCommonParams) {\n    const commonParams = generateCommonParams();\n    processedData = { ...commonParams, ...processedData };\n    requestInfo.data = processedData;\n  }\n  \n  // 3. 敏感参数处理\n  if (INTERCEPTOR_CONFIG.enableSensitiveParams) {\n    processedData = handleSensitiveParams(processedData);\n    requestInfo.data = processedData;\n  }\n  \n  // 4. 参数格式转换\n  if (INTERCEPTOR_CONFIG.enableFormatTransform && method.toUpperCase() !== 'GET') {\n    // 检测是否需要转换为form-data\n    if (processedHeader['Content-Type'] && processedHeader['Content-Type'].includes('multipart/form-data')) {\n      processedData = transformToFormData(processedData);\n      requestInfo.data = processedData;\n    }\n  }\n  \n  // 记录日志\n  logRequest(url, processedData, method, processedHeader, 'Before Interception');\n  \n  return requestInfo;\n};\n\n// 请求拦截器主函数\nexport const applyRequestInterceptors = (url, data, method, header) => {\n  let processedData = deepClone(data || {});\n  let processedHeader = { ...header };\n  \n  // 1. 防重复提交检查\n  if (INTERCEPTOR_CONFIG.enableDuplicateControl) {\n    const duplicateCheck = checkDuplicateRequest(url, processedData, method);\n    if (duplicateCheck.isDuplicate) {\n      return { isDuplicate: true, data: processedData, header: processedHeader };\n    }\n  }\n  \n  // 2. 通用参数补全\n  if (INTERCEPTOR_CONFIG.enableCommonParams) {\n    const commonParams = generateCommonParams();\n    processedData = { ...processedData, ...commonParams };\n  }\n  \n  // 3. 敏感参数处理\n  if (INTERCEPTOR_CONFIG.enableSensitiveParams) {\n    processedData = handleSensitiveParams(processedData);\n  }\n  \n  // 4. 参数格式转换（根据Content-Type决定）\n  if (INTERCEPTOR_CONFIG.enableFormatTransform) {\n    if (processedHeader[\"Content-Type\"] && processedHeader[\"Content-Type\"].includes(\"form-data\")) {\n      processedData = transformToFormData(processedData);\n    }\n  }\n  \n  // 5. 日志记录\n  if (INTERCEPTOR_CONFIG.enableLogging) {\n    logRequest(url, processedData, method, processedHeader, 'Before Request');\n  }\n  \n  return { isDuplicate: false, data: processedData, header: processedHeader };\n};\n\n// 默认导出所有拦截器功能\nexport default {\n  INTERCEPTOR_CONFIG,\n  SENSITIVE_PARAMS_CONFIG,\n  DUPLICATE_CONFIG,\n  generateCommonParams,\n  transformToFormData,\n  handleSensitiveParams,\n  checkDuplicateRequest,\n  releaseRequestLock,\n  logRequest,\n  requestInterceptor,\n  applyRequestInterceptors\n};\n"],"names":["md5Module","deepClone","uni"],"mappings":"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"}
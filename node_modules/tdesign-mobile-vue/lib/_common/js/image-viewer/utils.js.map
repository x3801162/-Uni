{"version":3,"file":"utils.js","sources":["../../../../src/_common/js/image-viewer/utils.ts"],"sourcesContent":["import { isArray, isString } from 'lodash-es';\nimport type { ImageInfo, Images } from './types';\n\nconst isSameOrigin = (url: string) => {\n  try {\n    const imgUrl = new URL(url, window.location.href);\n    return imgUrl.origin === window.location.origin;\n  } catch {\n    return true;\n  }\n};\n\nconst directDownload = (imgSrc: string, name: string) => {\n  const a = document.createElement('a');\n  a.download = name;\n  a.href = imgSrc;\n  a.click();\n  a.remove();\n};\n\nconst canvasDownload = (imgSrc: string, name: string) => {\n  const image = new Image();\n  image.setAttribute('crossOrigin', 'anonymous');\n\n  image.onload = () => {\n    const canvas = document.createElement('canvas');\n    canvas.width = image.width;\n    canvas.height = image.height;\n\n    const context = canvas.getContext('2d');\n    context.drawImage(image, 0, 0, image.width, image.height);\n    canvas.toBlob((blob) => {\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.download = name;\n      a.href = url;\n      a.click();\n      a.remove();\n      URL.revokeObjectURL(url);\n    });\n  };\n\n  image.src = imgSrc;\n};\n\nconst fileDownload = (file: File, name: string) => {\n  const url = URL.createObjectURL(file);\n  const a = document.createElement('a');\n  a.download = name;\n  a.href = url;\n  a.click();\n  a.remove();\n  URL.revokeObjectURL(url);\n};\n\nexport const downloadFile = (imgSrc: string | File) => {\n  const randomName = Math.random().toString(32).slice(2);\n\n  if (imgSrc instanceof File) {\n    fileDownload(imgSrc, imgSrc.name);\n    return;\n  }\n\n  // fix: https://github.com/Tencent/tdesign-vue-next/issues/2936\n  // 当链接携带了参数时，需处理掉参数再取图片名称，否则扩展名会与参数链接导致原扩展名失效\n  // 例如：img.png?sign=xxx 不处理参数会被转成 img.png_sign=xxx\n  const name = imgSrc?.split?.('?')?.[0]?.split?.('#')?.[0]?.split?.('/').pop()\n    || randomName;\n\n  if (isSameOrigin(imgSrc)) {\n    directDownload(imgSrc, name);\n  } else {\n    canvasDownload(imgSrc, name);\n  }\n};\n\nconst isImageInfo = (image: string | File | ImageInfo): image is ImageInfo => !!image && !isString(image) && !(image instanceof File);\n\nexport const formatImages = (images: Images): ImageInfo[] => {\n  if (!isArray(images)) return [];\n  return images.map((item) => {\n    if (isImageInfo(item)) {\n      return {\n        download: true,\n        thumbnail: item.mainImage,\n        ...item,\n      };\n    }\n    return {\n      mainImage: item,\n      thumbnail: item,\n      download: true,\n    };\n  });\n};\n"],"names":["isSameOrigin","url","imgUrl","URL","window","location","href","origin","_unused","directDownload","imgSrc","name","a","document","createElement","download","click","remove","canvasDownload","image","Image","setAttribute","onload","canvas","width","height","context","getContext","drawImage","toBlob","blob","createObjectURL","revokeObjectURL","src","fileDownload","file","downloadFile","_imgSrc$split","_imgSrc$split$split","_imgSrc$split$split$s","randomName","Math","random","toString","slice","File","split","call","pop","isImageInfo","isString","formatImages","images","isArray","map","item","_objectSpread","thumbnail","mainImage"],"mappings":"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"}